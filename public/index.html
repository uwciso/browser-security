<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="stylesheets/styles.css" />
  <title>Browser Security Exercises</title>
</head>
<body>

  <div class="banner main">
    <h1>Browser Security Exercises</h1>
  </div>
  <span class="glyphicon glyphicon-fire"></span>

  <div class="instr-wrapper">
    <p><img src="/img/exclamation.png" />All exercises refer to the <a href="/assets.html" target="0">assets page</a>. Keep it open on another browser tab (along with Dev Tools), as you'll be referring to it throughout.</p>
  </div>

  <h2 class="first">Content Security Policy (CSP)<span class="resource"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="0">MDN</a></span></h2>

  <p class="instructions">Open up the app.js file in a text editor, and for each CSP challenge below, create a corresponding content security policy by editing the <a href="https://github.com/uwciso/browser-security/blob/master/app.js#L4-L6" target="blank"><code>csp_directives</code> object</a>. Refer to the <a href="https://helmetjs.github.io/docs/csp/" target="0">Helmet.js docs</a> for syntax guidance. </p>

  <div class="csp-challenges">
    <div class="written-instr">
      <p class="instructions"><b>CSP Challenges</b></p>
      <span class="sub-instructions">Each challenge refers to assets loaded (or not) by the <a href="/assets.html">assets page</a>.</span>
      <ol>
        <li>Set a default policy which allows <i>only</i> local assets to be loaded (all inline scripts should be blocked).</li>
        <li>In addition to the local stylesheet and (non-inline) scripts, allow the Bootstrap stylesheet to be loaded from its CDN.</li>
        <li>In addition to all stylesheets and local (non-inline) scripts, allow <i>all</i> images to be loaded.</li>
        <li>In addition to all stylesheets and images, allow <i>only</i> scripts from the code.jquery.com CDN.</li>
        <li>Now, allow scripts from the jQuery CDN as well as any local scripts (but still block all inline scripts).</li>
        <li>In addition to scripts from the jQuery CDN and local scripts, allow inline script A by using a hash (HINT: Chrome Dev Tools will provide the base64 value of the script's SHA256 hash in its console error message when refusing to run it).</li>
        <li>Find two ways in which to allow <i>both</i> inline scripts as well as all other assets. Is one method preferable over the other?</li>
      </ol>
    </div>
    <div class="table-instr">
      <table class="challenges">
        <thead>
          <tr>
            <th></th>
            <th>Inline Script A</th>
            <th>Inline Script B</th>
            <th>Local Script</th>
            <th>Local Image</th>
            <th>External Image</th>
            <th>Local Stylesheet</th>
            <th>Bootstrap Stylesheet (via CDN)</th>
            <th>jQuery (via CDN)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>1</th>
            <td class="no"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="no"></td>
            <td class="no"></td>
          </tr>
          <tr>
            <th>2</th>
            <td class="no"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="no"></td>
          </tr>
          <tr>
            <th>3</th>
            <td class="no"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="no"></td>
          </tr>
          <tr>
            <th>4</th>
            <td class="no"></td>
            <td class="no"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
          </tr>
          <tr>
            <th>5</th>
            <td class="no"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
          </tr>
          <tr>
            <th>6</th>
            <td class="yes"></td>
            <td class="no"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
          </tr>
          <tr>
            <th>7</th>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
            <td class="yes"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <p class="instructions">To see the results of each CSP modification:</p>
  <ul>
    <li>Reload the <a href="/assets.html">assets page</a>, and observe the "Page Assets" section to verify what was loaded/executed (with the exception of the local stylesheet and external CDN resources, which will require Dev Tools).</li>
    <li>Verify the local stylesheet and external CDN resources (jQuery and the Bootstrap stylesheet) on the assets page by opening Dev Tools, reloading the page, and observing requests on the <a href="/network-tab.html">Network tab</a>.
    </li>
  </ul>
  <p>To see solutions to each CSP challenge, view the <a href="https://github.com/uwciso/browser-security/blob/master/app.js" target="0">app.js</a> file on its corresponding branch.</p>

  <h2>X-XSS-Protection Header<span class="resource"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection" target="0">MDN</a></span></h2>
  <ol>
    <li>
      <p>As an added layer of protection for older browsers not supporting CSP, make sure the <code>X-XSS-Protection</code> header is set for all responses. This can be done by adding a single line to the app.js file using Helmet.js's <a href="https://helmetjs.github.io/docs/xss-filter/" target="0">XSS Filter</a> module.</p>
      <p>Reload the assets page and verify this header is indeed set.</p>
    </li>
  </ol>
  <h2>Subresource Integrity <span class="resource"><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="0">MDN</a></span></h2>
  <p>Right now, the assets page pulls in jQuery from a CDN, and in doing so, is trusting that the CDN will serve an uncorrupted file. If the file were modified, the browser would have no way to detect that.</p>
  <ol>
    <li>
      <p>Add another layer of security for this file by adding an <code>integrity</code> attribute on the <a href="https://github.com/uwciso/browser-security/blob/master/assets.html#L75" target="blank">script tag</a> of the assets.html file. For the attribute's value, you can easily generate a hash of the (jQuery) file using this <a href="https://www.srihash.org/" target="0">SRI Hash Generator</a>. Don't forget to include a <code>crossorigin="anonymous"</code> attribute as well (see <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_settings_attributes" target="0">MDN</a> for more information on this attribute).</p>
      <p>Reload the assets page and verify that the resource loads as expected.</p>
    </li>
    <li>
      <p>Modify the value of the <code>integrity</code> attribute so the browser's calculated value will not match. Has the resource been blocked by the browser? (Verifying this can be tricky, since the Network tab will show the file as having been loaded (which is true, since the file had to be downloaded in order for the browser to check its hash). You can attempt to execute a jQuery selection in the console window, or, in Chrome Dev Tools, use the Source tab to see if that file is available.</p>
    </li>
    <li>
      <p>Now, with the integrity attribute correctly applied, remove just the <code>crossorigin="anonymous"</code> attribute, and reload the assets page. Does the script resource load? Why or why not?</p>
    </li>
  </ol>
  <h2>Explicit MIME Types and Disabling MIME Sniffing<span class="resource"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="0">MDN</a></span></h2>
  <ol>
    <li>
      <p>For each of the assets page's local resources, check the response to verify a <code>Content-Type</code> header was sent (use the Dev Tools Network tab).</p>
    </li>
    <li><p>Verify whether or not browser MIME sniffing has been explicitly disabled by the server (to prevent the browser potentially making its own guess at the resource's content type and ignoring information sent by the server). If it hasn't, fix this using Helmet.js's <a href="https://helmetjs.github.io/docs/dont-sniff-mimetype/" target="0">noSniff module</a> (you'll need to add a line in the app.js file).
     Reload the assets page, and verify the presence of the appropriate response header (<code>X-Content-Type-Options: nosniff</code>).</p>
  </ol>
  <h2>Safer Cookies<span class="resource"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie" target="0">MDN</a></span></h2>
  <p>For these exercises, you'll need to edit the <code>res.cookie</code> method in the <a href="https://github.com/uwciso/browser-security/blob/master/app.js#L22-L26" target="0">app.js</a> file. Refer to the <a href="https://expressjs.com/en/4x/api.html#res.cookie" target="0">Express docs</a> for more info on this method.</p>
  <ol>
    <li>
      <p>Note that this app sets a 'newcookie' cookie on the initial response with a value of 'chocolate-chip'. Use <code>document.cookie</code> in the Dev Tools console to see this cookie and its value. Now, add the <code>httpOnly</code> directive to this cookie to prevent it from being accessed directly with JS methods.</p>
      <p>Reload the assets page and try accessing the cookie again through the console with <code>document.cookie</code>.</p>
    </li>
    <li>
      <p>Check that this cookie is sent on subsequent requests to local (same-origin) resources (such as this page's stylesheet or image) by inspecting the <code>Cookie</code> request header. Now, disallow this cookie from being sent on requests <i>not</i> over https by using the <code>secure</code> directive.</p>
      <p>Reload the assets page, then check those same requests to verify this cookie was not sent (since this app is making those local requests over http rather than https).</p>
    </li>
    <li>
      <p>Ensure that this cookie won't be sent along with any cross-site (third party) requests by adding the <code>sameSite</code> directive.</p>
    </li>
    <li>
      <p>Finally, give this cookie an explicit expiration date using the <code>Expires</code> directive (HINT: an easy way to provide a date value is to  use <code>new Date(Date.now + 1000)</code>).</p>
    </li>
      <p>Reload the assets page and check that the cookie reflects these updates.</p>
    </li>
  </ol>
</body>
</html>
